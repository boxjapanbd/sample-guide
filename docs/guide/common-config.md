# 共通準備・アプリ設定



[TOC]





変更履歴

v1.0 2021-01-20 小林



## ドキュメント利用に関する注意事項

Box Platform ドキュメントライブラリの各文書は、Box API / SDK / UI Elements を使ったカスタムアプリケーションの開発方法の理解促進を目的として作成されており、関連するBoxサービスやサンプルアプリケーションの動作を保証するものではありません。本書は、現状有姿（As-Is）の情報を元に構成されており、内容は随時変更される場合があります。また、本書の内容に関して、サポートサービスは提供されませんので、あらかじめご了承ください。



## このドキュメントの概要

このドキュメントでは、カスタム・アプリケーションの作成のための前段階としてのアプリケーション設定の作成方法を学びます。

​    



# BOXでアプリ設定の準備





## BoxDevでの操作（初回のみ）



ここからカスタムアプリケーションを作成して行きます。

初回のみ、BoxDev : https://ja.developer.box.com/ にアクセスし、画面右上の「ログイン」から、BOXにログインを行います。

ログインが済んでいる場合は、画面右上に「マイアプリ」というボタンが表示されます。



![image-20201208122203707](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/boxDevTop.png)



「マイアプリ」または、「開発者コンソールに移動」をクリックすると、開発者コンソールのマイアプリ画面が表示されるようになります。

開発者コンソールは今後よくアクセスするので、ブックマークに登録しておくことをおすすめします。





## アプリの新規作成

開発者コンソール（＝マイアプリ）を開き、アプリの新規作成ボタンをクリックします。

サンドボックスが利用可能な環境であれば、サンドボックス内でも同様の操作が行なえます。



![myAppTop](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/myAppTop.png)





アプリタイプの選択を行います。

アプリの種類はここでは一番左側のカスタムアプリを選択します。

Box Viewアプリと、Box Skillsを利用する場合のみ、その他の項目を選択しますが、ここでは割愛します。



![myappCreateNewApp](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/myappCreateNewApp.png)





次に、認証方法を選択します。



## カスタムアプリの認証方式 概要



マイアプリの新規作成時に、カスタムアプリの認証方式を選択する必要があります。

BOXのカスタムアプリには以下の3つの認証方式が存在します。

- サーバー認証（JWT使用）
- ユーザー認証（OAuth 2.0）
- サーバー認証（クライアント資格情報の許可）

それぞれ以下のような特徴があります。



サーバー認証とユーザー認証の主な違い

|                              | サーバー認証                                                 | ユーザー認証                |
| ----------- | ------------ | ------------ |
| 方式                         | JWT使用、または<br>クライアント資格情報の許可 ※      | OAuth 2.0                   |
| 利用ユーザー                 | サービスアカウント<br/>アプリユーザー<br/>(管理対象ユーザーも可能) | 管理対象ユーザー            |
| 主な課金方式（例外あり）      | Box Platform (従量課金)                                      | Box Core （ユーザー数課金） |
| 管理者による<br>アプリの承認 | 必要                                                         | 不要                        |
| アクセストークン<br>取得のためのサーバー | 必要 | 不要              |
| ユーザーによるBOXへのログイン操作 | 不要 | 必要 |
| アプリユーザーの利用（処理の並列化） | 可能 | 不可能 |
| 人が関与しないプログラムからの操作に利用 | 可能 | 不可能（[Fair Use Policy](https://www.box.com/legal/fairusepolicy)で禁止） |
| Emailアドレスを持たないユーザーの利用 | 可能 | 不可能 |
| 商用サービスのバックエンドとしての利用<br>（Boxテナントの又貸し） | 可能 | 不可能 |
| 別のユーザーとして実行（As User）の利用 | 可能 | 可能 |
| ユーザーアクセストークンを生成 | 可能 | 不可能 |
| Webhook v1, v2の利用 | 可能 | 可能 |
| ウェブアプリ統合の利用 | 不可能 | 可能 |
| アプリギャラリーへの登録 | 不可能 | 可能 |



※ 「JWT」と「クライアント資格情報の許可」は、最終的に行えることは同じです。「クライアント資格情報の許可」は「JWT」と違い、キーペアの準備やJWTアサーションを作る必要がなく、IDとパスワードのみでサービスアカウントを認証することが可能です。このためSDKを利用できない環境からAPIを実行したい場合に利用すると実装が簡単になります。SDKを利用する場合は、クライアント資格情報の許可を選択するメリットは有りませんので、サーバー認証を利用する場合はJWT使用を選択してください。参考：[Client Credentials Grant](https://medium.com/box-developer-blog/client-credentials-grant-f533856f55be)





# サーバー認証

認証方法でサーバー認証（JWT使用、または、クライアント資格情報の許可）を利用する場合の解説です。

ユーザー認証を利用する場合はスキップしてください。





## サーバー認証（JWT使用）



認証方法でサーバー認証（JWT使用）を選択する場合の解説です。



「サーバー認証（JWT使用）」は、Box APIで認証するための最も強力な方法の一つです。

「サーバー認証（クライアント資格情報の許可）」と違い、公開/秘密鍵を元に、JWTアサーションを作成し、アクセストークンを取得します。

堅牢なしくみですが、SDKを使わずに利用する場合、少し煩雑な作業が必要になります。

JWTのこれらの煩雑な作業は、SDKを利用することで省力化することができます。

SDKを使えない場合は「サーバー認証（クライアント資格情報の許可）」はシンプルにな代替になります。





### アプリの作成



カスタムアプリで、「サーバー認証（JWT使用）」を選択し、任意のアプリ名をつけて「アプリの作成」をクリックします。



![スクリーンショット 2020-12-09 16.38.21](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/customAppJWT.png)



アプリが作成されます。

アプリ設定の内容を確認します。





### 一般設定タブ

一般設定タブでは特に理由がなければ変更するものは有りません。ここでは内容だけ確認します。



![jwt-conf-1-1](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/jwt-conf-1-1.png)

- アプリ情報

    - アプリ名の変更が可能です。
    - 連絡先メールの変更が可能です。

    

![jwt-conf-1-2](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/jwt-conf-1-2.png)



- コラボレータ
    - コラボレータの追加、削除が可能です。
    - 追加されたユーザーはこのアプリ設定にアクセスするこができるようになります。
- アプリを削除
    - アプリを削除可能です。削除するには2要素認証を有効にする必要があります。





### 構成タブ

構成ページではアプリの特性などに合わせていくつか変更を行います。



![jwt-conf-2-1](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/jwt-conf-2-1.png)



- 認証方法

    - 認証方法を表示しています。
    - 一度アプリを作成すると認証方法を変更することはできません。
    
- 開発者トークン

    - 有効期限が60分の開発者トークン（アクセストークン）を利用可能です。
    
    - ちょっとだけAPIを試したいが、わざわざ認証部分を作り込むのが面倒という場合につかえます。
    
        

![jwt-conf-2-2](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/jwt-conf-2-2.png)




- OAuth 2.0資格情報
    - クライアントIDは、カスタムアプリ自体のIDです。
    - 管理者は直接このクライアントIDを指定して承認することも可能です。
- アプリアクセスレベル

    - サービスアカウントと、サービスアカウントが作成するアプリユーザーのコンテンツにのみアクセスすればよい場合は、アプリアクセスのみを選択します。特に理由がなければデフォルトのままにします。
    
    - Enterprise設定や、アプリケーションの枠を超えて、Boxテナント内のその他の管理対象ユーザーのコンテンツにアクセスしたい場合は、アプリアクセス＋Enterpriseアクセスを選択します。
    
        

![jwt-conf-2-3](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/jwt-conf-2-3.png)



- アプリケーションスコープ

    - アプリにやれることを有効化します。
    - **必要に応じて選択します。**

    


![jwt-conf-2-4](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/jwt-conf-2-4.png)



- 高度な機能

    - 「[別のユーザーとして実行]機能を使用してAPI呼び出しを行う」をONにすると、サービスアカウントのトークンを使いながら、別のユーザーに成り代わって（As User）操作が可能になります。
    - 「ユーザーアクセストークンを生成」をONにすると、アプリユーザーとしてのアクセストークンを発行できます。これは、SDKの操作に置き換えて言うと、アプリユーザーのClientオブジェクトを作成できるということになります。
    - **必要に応じて選択します。**

- 公開キーの追加と管理

    - **「公開/秘密キーペアを生成」ボタンを押します。**

    - 2要素認証の設定がされていない場合はアラートが出ますので、アラートのSettingsボタンを押すか、開発者コンソール画面右上のアバターアイコンからアカウント設定を選択します。「アカウントを保護するために２段階認証を要求する」をチェックします。スマートフォンの番号を入れ、送信されたSMSの認証番号を入れ、保存します。開発者コンソールの作成したアプリの構成に戻ります。もう一度、公開キーの追加と管理の、「公開/秘密キーペアを生成」ボタンを押します。

    - 324763110_6v5hmyd7_config.json のような名前のファイルがダウンロードされます。このファイルは、あとでアプリケーション開発環境から利用します。以降config.jsonという名前で説明します。

- CORSドメイン

    - CORSを許可するURLを入れます。
    - UI Elementsを利用する場合や、シングルページアプリケーション(SPA)等でブラウザからAPIを直接実行する場合に設定します。
    - UI Elementsを利用する予定がないなど、ブラウザから直接APIを実行する必要が無い場合この設定は不要です。
    - 例えば、UI Elementsをlocalhost:3000で実行したい場合、`http://localhost:3000`を追加します。カンマ区切りで複数設定可能です。
    - この設定により、許可をしたURLからのリクエストに対して、CORSレスポンスヘッダーが含まれるようになります。これから作成するカスタムWebサイトとオリジンが異なるBOX APIに、同一オリジンポリシーの制限を超えてXMLHttpRequestやFetch APIから直接APIリクエストを送ることができるようになります。

- アプリ設定

    - 公開キーの追加と管理でダウンロードしたconfig.jsonファイルからキーペア情報が抜かれたものがダウンロードされます。すでに「公開/秘密キーペアを生成」を実行し、設定ファイルをダウンロード済みなので、こちらは不要です。



### Webhookタブ

Webhookのタブは、Webhookに署名をするためのキーの設定と、現在非推奨のWebhook V1の作成を行えます。

ここでは割愛します。

​    

### 承認タブ



![jwt-conf-4](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/jwt-conf-4.png)



アプリの承認 

- サーバー認証のアプリは管理者により承認される必要があります。
- アプリの承認欄の「確認して送信」ボタンは管理者に申請を依頼するためのボタンです。ボタンを押すと管理者にメールが送信されます。
- 管理者は管理コンソールのアプリからカスタムアプリタブを開き、アプリの承認を行うことができます。
- **構成ページで設定が終わったら、アプリの承認申請を行い、管理者により承認されることで、アプリが実行できるようにします。**



これでサーバー認証方式（JWT）で開発を行う準備ができました。





## サーバー認証（クライアント資格情報の許可）



認証方法でサーバー認証（クライアント資格情報の許可）を選択する場合の解説です。

設定方法などはJWTの解説を確認してください。

基本的に、JWTとほぼ同様の設定となります。主な違いは以下のとおりです。



### JWTとの主な違い



- 公開/秘密キーペアの生成が無い
    - サーバー認証（JWT使用）と違い、クライアントIDとクライアントシークレットのみで認証を行うため公開/秘密キーペアがない
- OAuth 2.0資格情報のクライアントシークレットを取得：
    - クライアントシークレットのみを認証に利用するため、取り扱いがJWTに比べより厳重になっている。クライアントシークレットの取得には2FAが必要になる。
- SDKを利用することを前提にしていない。（各種SDKはこの認証方式をサポートしていない）



JWTと同様に管理コンソールから承認を行い、利用してください。詳細はJWTを御覧ください。





# ユーザ認証



認証方法でユーザー認証（OAuth 2.0）を利用する場合の解説です。

サーバー認証を利用する場合はスキップしてください。



ユーザー認証（OAuth 2.0）は、Boxにアカウントをもつユーザー（管理対象ユーザー）が、自分のデータにアクセスできるようにすることを目的とした認証方法です。



### アプリの設定の確認



カスタムアプリで、「ユーザー認証（OAuth 2.0）」を選択し、任意のアプリ名をつけて「アプリの作成」をクリックします。



![uauthCreate](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/uauthCreate.png)





アプリが作成されます。

アプリ設定の内容を確認します。

ユーザー認証では、サーバー認証と異なり、一般設定、構成、Webhookのほか、統合とアプリギャラリーの設定も追加されます。



![uauthTabs](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/uauthTabs.png)





#### 一般設定タブ

一般設定タブでは特に理由がなければ変更するものは有りません。ここでは内容だけ確認します。

サーバー認証と違い、アプリの承認は不要なため、アプリの承認タブは有りません。



![uauthIppan](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/uauthIppan.png)



この画面で行えることは以下の通りです。

- アプリ名の変更

- 連絡先メールの変更

- コラボレータの追加

    - 開発者のコラボレーターです。追加することでこのアプリ設定にアクセスするこができるようになります。

- アプリの削除

    



#### 構成タブ

構成ページではアプリの特性などに合わせていくつか変更を行います。



![uauthKousei1](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/uauthKousei1.png)

- 認証方法

    - 認証方法を表示しています。
    - 一度アプリを作成すると認証方法を変更することはできません。

- 開発者トークン

    - 有効期限が60分の開発者トークン（アクセストークン）を利用可能です。ちょっとだけAPIを試したいが、わざわざ認証部分を作り込むのが面倒という場合につかえます。

![uauth-conf-2](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/uauth-conf-2.png)



- OAuth 2.0資格情報
    
    - クライアントIDは、カスタムアプリ自体のIDです。
- OAuth 2.0リダイレクトURI

    - OAuth 2.0 Authorization Code Grant Flow で、Box IdpにリダイレクトさせるカスタムアプリのURIを指定します。
    - Webアプリケーションの場合、カスタムアプリケーションが、ブラウザ上でリダイレクトを受け取るためのURIになります。
    - **リダイレクトURIを設定します。**
- アプリケーションスコープ

    - 必要に応じてスコープ（=アプリがやれること）を有効化します。
    
    - **必要に応じて設定します**
    
        

![uauth-conf-3](Box Platform 開発クイックスタートガイド 共通準備・アプリ設定.assets/uauth-conf-3.png)



- 高度な機能
    - 「[別のユーザーとして実行]機能を使用してAPI呼び出しを行う」をONにすると、別のユーザーに成り代わって（As User）操作が可能になります。
- CORSドメイン
    - CORSを許可するURLを入れます。
    - UI Elementsを利用する場合や、シングルページアプリケーション等でブラウザからAPIを直接実行する場合に設定します。
    - UI Elementsを利用する予定がないなど、ブラウザから直接APIを実行する必要が無い場合この設定は不要です。
    - 例えば、UI Elementsをlocalhost:3000で実行したい場合、`http://localhost:3000`を追加します。カンマ区切りで複数設定可能です。
    - この設定により、許可をしたURLからのリクエストに対して、CORSレスポンスヘッダーが含まれるようになります。これから作成するカスタムWebサイトとオリジンが異なるBOX APIに、同一オリジンポリシーの制限を超えてXMLHttpRequestやFetch APIから直接APIリクエストを送ることができるようになります。



#### Webhookタブ

Webhookのタブは、Webhookに署名をするためのキーの設定と、現在非推奨のWebhook V1の作成を行えます。

ここでは割愛します。



#### 統合タブ

ウェブアプリ統合の設定をおこなえます。Box標準画面にカスタムボタンを追加し、任意の外部アプリケーションを実行できるようになります。ここでは割愛します。

ウェブアプリ統合はユーザー認証のアプリのみ利用可能となります。



#### アプリギャラリータブ

アプリギャラリーへの申請を行えます。ここでは割愛します。

アプリギャラリーの利用はユーザー認証のアプリのみ利用可能となります。



これでユーザー認証方式で開発を行う準備ができました。

